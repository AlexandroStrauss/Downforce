<!DOCTYPE html>
<html>

<head>
    <title>My first three.js app</title>
    <style>
        body {
            margin: 0;
        }

        canvas {
            width: 100%;
            height: 100%
        }
    </style>
</head>

<body>
    <script src="js/three.js"></script>
    <script src="js/controls/OrbitControls.js"></script>
    <script src="GLTFLoader.js"></script>
    <script src="js/keyUpHandler.js"></script>
    <script src="js/keyDownHandler.js"></script>
    <script src="js/collisions.js"></script>
    <script type="text/javascript" src="/js/physi.js"></script>

    <script>

        'use strict';

        Physijs.scripts.worker = '/js/physijs_worker.js';
        Physijs.scripts.ammo = '/js/ammo.js';

        var rightPressed = false;
        var leftPressed = false;
        var upPressed = false;
        var downPressed = false;

        document.addEventListener("keydown", keyDownHandler, false);
        document.addEventListener("keyup", keyUpHandler, false);

        var velocity = 0;
        var velX = 0;
        var velZ = 0;
        var angle = 0;

        var scene = new THREE.Scene();
        scene.background = new THREE.Color(0xff0000);

        var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);

        var renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        var loader = new THREE.GLTFLoader();

        var car;

        loader.load('2018_nascar_camaro/scene.gltf', function (gltf) {
            car = gltf.scene;
            scene.add(gltf.scene);
        }, undefined, function (error) {
            console.error(error);
        })

        var geometry = new THREE.BoxGeometry(90, 300, 90);
        var material = new THREE.MeshBasicMaterial({ color: 0x0000ff });
        var tower = new THREE.Mesh(geometry, material);
        var tower2 = new THREE.Mesh(geometry, material);
        scene.add(tower);
        scene.add(tower2);
        tower.position.set(-300, 150, 0);
        tower2.position.set(300, 150, 0);

        geometry = new THREE.BoxGeometry(100, 100, 200);
        material = new THREE.MeshBasicMaterial({color: 0xff0add});
        var boundingBox = new THREE.Mesh(geometry, material);
        scene.add(boundingBox);

        var frontstretchGeometry = new THREE.BoxGeometry(100, 100, 2000);
        var frontstretchMaterial = new THREE.MeshBasicMaterial({ color: 0xff7800});
        var frontstretch = new THREE.Mesh(frontstretchGeometry, frontstretchMaterial);
        var frontstretch2 = new THREE.Mesh(frontstretchGeometry, frontstretchMaterial);
        scene.add(frontstretch);
        scene.add(frontstretch2);
        frontstretch.position.set(300, 50, 200);
        frontstretch2.position.set(-300, 50, 200);

        var backstretch = new THREE.Mesh(frontstretchGeometry, frontstretchMaterial);
        scene.add(backstretch);
        backstretch.position.set(-1180, 50, 200);

        var cylinderGeometry = new THREE.CylinderGeometry (500, 500, 150, 64, 1, false, 0)
        var cylinderMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff})
        var cylinder = new THREE.Mesh(cylinderGeometry, cylinderMaterial);
        var cylinder2 = new THREE.Mesh(cylinderGeometry, cylinderMaterial);
        scene.add (cylinder)
        scene.add (cylinder2)
        cylinder.position.set(-740, 75, 1150)
        cylinder2.position.set(-740, 75, -950)

        var controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableKeys = false;

            //controls.update() must be called after any manual changes to the camera's transform
            // camera.position.set(0, 75, 200)
            camera.position.set(0, 3000, 0)
            controls.update();

        var collidableObjects = [frontstretch, frontstretch2, cylinder, cylinder2, backstretch]

        var animate = function () {
            requestAnimationFrame(animate);

            // car.rotation.x += 0.02;
            // car.rotation.y += 0.02;
            // car.rotation.z += 0.02;

            // approximate downforce for a NASCAR car, assuming 2000lbs at 180mph
            var downforce = .312 * (Math.pow((velocity * .44704), 2))

            if (upPressed && velocity >= 0) {
                var acceleration = (22.7 - (0.0864 * velocity) - (0.0000892 * Math.pow(velocity, 2)))/120
                velocity += acceleration
            } else if (upPressed && velocity < 0) {
                var deceleration = (-33.6 - 3.12 * Math.log(Math.abs(velocity))) / 120
                velocity -= deceleration
            }

            if (downPressed && velocity > 0) {
                var deceleration = (-33.6 - 3.12 * Math.log(velocity))/60
                velocity += deceleration
            } else if (downPressed && velocity <= 0) {
                velocity = -5;
            }

            // var angleChange = Math.log(1/((Math.abs(velocity) ) / 600))/150;
            var angleChange = velocity/600;

            if (leftPressed) {
                angle += angleChange;
                car.rotation.y += angleChange;
                boundingBox.rotation.y += angleChange;
                // camera.rotation.y += angleChange;
            }

            if (rightPressed) {
                angle -= angleChange;
                car.rotation.y -= angleChange;
                boundingBox.rotation.y -= angleChange;
                // camera.rotation.y -= angleChange;
            }

            if (!upPressed && !downPressed) {
            velocity *= 0.99;
            }
            //these are swapped because of the starting direction of the car.
            //X should be calculated from cosine, Z from sine
            velX = velocity * Math.sin(angle);
            velZ = velocity * Math.cos(angle);

            car.position.z -= (velZ)
            car.position.x -= (velX)

            boundingBox.position.z -= (velZ)
            boundingBox.position.x -= (velX)

            // camera.position.x -= (velX)
            // camera.position.z -= (velZ)

            // if (collisions(boundingBox, collidableObjects)) {
            //     velocity = 0;
            // }

            camera.lookAt(car);

            controls.update();

            renderer.render(scene, camera);
        };

        animate();
    </script>
</body>

</html>